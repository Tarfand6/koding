version: 2

jobs:

  build:

    resource_class: large

    docker:
      - image: koding/circle@sha256:33519ba755fd1a436e7891782a65b1d99b02fafebc104bd0e8ed9bc5e83d3e71

    working_directory: ~/koding

    steps:
      - checkout

      - restore_cache:
          keys:
            - node_modules-{{ checksum "package.json" }}
      - restore_cache:
          keys:
            - client-node_modules-{{ checksum "client/package.json" }}
      - restore_cache:
          keys:
            - landing-node_modules-{{ checksum "client/landing/package.json" }}

      - run:
          name: npm install
          command: npm install --unsafe-perm

      - save_cache:
          key: node_modules-{{ checksum "package.json" }}
          paths:
            - node_modules
      - save_cache:
          key: client-node_modules-{{ checksum "client/package.json" }}
          paths:
            - client/node_modules
      - save_cache:
          key: landing-node_modules-{{ checksum "client/landing/package.json" }}
          paths:
            - client/landing/node_modules

      - run:
          name: credentials
          command: env BRANCH=$CIRCLE_BRANCH scripts/copy-deployment-credentials.sh

      - run:
          name: configure
          command: ./configure --config dev --version $(git rev-parse --short HEAD) --host dev.koding.com:8090 --hostname dev.koding.com --countlyApiPort "80"

      - restore_cache:
          keys:
            - go-{{ .Branch }}-{{ .Revision }}
            - go-{{ .Branch }}
            - go-master

      - run:
          name: touch files restored from cache
          working_directory: ~/koding/go
          command: |
            find bin -exec touch {} \;
            find pkg -exec touch {} \;

      - run:
          working_directory: ~/koding/go
          command: ls -l --recursive bin pkg

      - run: env GOGC=10 go/build.sh

      - run:
          working_directory: ~/koding/go
          command: ls -l --recursive bin pkg

      - save_cache:
          key: go-{{ .Branch }}-{{ .Revision }}-{{ epoch }}
          paths:
            - go/bin
            - go/pkg
      - save_cache:
          key: go-{{ .Branch }}-{{ epoch }}
          paths:
            - go/bin
            - go/pkg
